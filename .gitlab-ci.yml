variables:
  PROJECT: "product-finder"
  PROJECT_TITLE: "product-finder"
  MAVEN_BUILD_IMAGE: $CI_HARBOR_REGISTRY/ghcr/graalvm/native-image:22.3.2
  DOCKERFILE_PATH: $CI_PROJECT_DIR/bootstrap/src/main/docker/Dockerfile.native-micro
  MAVEN_CLI: ./mvnw

include:
  project: common/pipeline/templates
  file: .gitlab-ci-base.yml
  ref: "3"

get-version:
  extends: .get-version-base

# Use the maven build for native images
maven-build:
  extends: .maven-build-native-base

#Use the sonarqube check for native images
sonarqube-check:
  image: maven:3.9.3-eclipse-temurin-17
  stage: build
  variables:
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"  # Defines the location of the analysis task cache
    GIT_DEPTH: "0"  # Tells git to fetch all the branches of the project, required by the analysis task
  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - .sonar/cache
  script:
    - mvn -s settings.xml verify sonar:sonar -Dsonar.qualitygate.wait=true -Pcoverage
  allow_failure: true
  only:
    - merge_requests
    - develop

publish-docker-image:
  extends: .publish-docker-image-base
